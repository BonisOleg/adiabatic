{% extends 'base.html' %}
{% load i18n %}
{% load gallery_filters %}

{% block title %}{{ product.get_name }}{% endblock %}
{% block og_title %}{{ product.get_name }}{% endblock %}
{% block og_description %}{{ product.get_short_description|default:"–î–µ—Ç–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ø—Ä–æ–¥—É–∫—Ç"|truncatewords:20
}}{% endblock %}

{% block content %}
<!-- Hero Section (ADIABATIC Style) -->
<section class="hero">
    <div class="hero__container">
        <div class="hero__content js-observe">
            <p class="hero__subtitle slide-in-left">
                {{ product.category.get_name }}
            </p>
            <h1 class="hero__title fade-in">
                {{ product.get_name }}
            </h1>
            {% if product.get_short_description %}
            <p class="hero__description slide-in-up">
                {{ product.get_short_description }}
            </p>
            {% endif %}
            <div class="hero__actions">
                <a href="{% url 'leads:submit' %}" class="btn btn--primary btn--large">–ó–∞–º–æ–≤–∏—Ç–∏</a>
                <a href="{% url 'catalog:category_detail' product.category.slug %}"
                    class="btn btn--secondary btn--large">–î–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</a>
            </div>
        </div>
        <div class="hero__image-container js-observe">
            {% if product.hero_image %}
            <img src="{{ product.hero_image.url }}" alt="{{ product.get_name }}" class="hero__image">
            {% else %}
            <div class="adiabatic-placeholder">
                ‚öôÔ∏è {{ product.get_name }}
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Product Details Section -->
<section class="catalog-section">
    <div class="container">
        <div class="about-container">
            <!-- Product Description -->
            <div class="about-content js-observe">
                {% if product.get_description %}
                <h2 class="about-title">
                    –û–ø–∏—Å
                    <span class="about-title-accent">–ø—Ä–æ–¥—É–∫—Ç—É</span>
                </h2>
                <div class="about-description">
                    {{ product.get_description|safe }}
                </div>
                {% endif %}

                {% if product.price_usd %}
                <div class="price-highlight">
                    <div class="price-highlight__label">
                        –¶—ñ–Ω–∞
                    </div>
                    <div class="price-highlight__value">
                        ${{ product.price_usd }}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Technical Specifications -->
            {% if product.specifications.all %}
            <div class="about-features js-observe">
                <h3 class="about-features__title">
                    –¢–µ—Ö–Ω—ñ—á–Ω—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
                </h3>
                <div class="tech-specs">
                    {% for spec in product.specifications.all %}
                    <div class="tech-specs__row">
                        <div class="tech-specs__label">{{ spec.get_name }}</div>
                        <div class="tech-specs__value">{{ spec.value }}{% if spec.unit %} {{ spec.unit }}{% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Advantages Section -->
{% if product.advantages.all %}
<section class="catalog-section">
    <div class="container">
        <div class="catalog-header js-observe">
            <p class="catalog-subtitle">–ü–µ—Ä–µ–≤–∞–≥–∏ –ø—Ä–æ–¥—É–∫—Ç—É</p>
            <h2 class="catalog-title">
                –ß–æ–º—É –æ–±–∏—Ä–∞—é—Ç—å
                <span class="catalog-title-accent">{{ product.get_name }}</span>
            </h2>
            <div class="catalog-underline"></div>
        </div>

        <div class="equipment-grid">
            {% for advantage in product.advantages.all %}
            <div class="equipment-card js-observe">
                <div class="equipment-card__image">
                    {% if advantage.icon %}
                    <i class="{{ advantage.icon }}"></i>
                    {% else %}
                    ‚úì
                    {% endif %}
                </div>
                <div class="equipment-card__content">
                    <div class="equipment-card__title">
                        {{ advantage.get_title }}
                    </div>
                    {% if advantage.get_description %}
                    <p class="equipment-card__description">
                        {{ advantage.get_description }}
                    </p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Gallery Section -->
{% if product.gallery.all %}
<section class="catalog-section">
    <div class="container">
        <div class="catalog-header js-observe">
            <p class="catalog-subtitle">–ì–∞–ª–µ—Ä–µ—è —Ç–∞ 3D –º–æ–¥–µ–ª—ñ</p>
            <h2 class="catalog-title">
                {{ product.get_name }}
                <span class="catalog-title-accent">–º–µ–¥—ñ–∞</span>
            </h2>
            <div class="catalog-underline"></div>
        </div>

        <div class="equipment-grid">
            {% for gallery_item in product.gallery.all %}
            <div class="equipment-card js-observe">
                {% if gallery_item.content_type == 'IMAGE' %}
                <!-- Regular Image -->
                <div class="equipment-card__image-container"
                    onclick="openImageModal('{{ gallery_item.image.url }}', '{{ gallery_item.get_title|default:product.get_name }}')">
                    <img src="{{ gallery_item.image.url }}" alt="{{ gallery_item.get_title|default:product.get_name }}"
                        class="equipment-card__image">
                    <div class="equipment-card__overlay">
                        <span class="overlay-icon">üîç</span>
                        <span class="overlay-text">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏</span>
                    </div>
                </div>

                {% elif gallery_item.content_type == '3D_MODEL' %}
                <!-- 3D Model -->
                <div class="equipment-card__image-container">
                    {% if gallery_item.preview_image %}
                    <img src="{{ gallery_item.preview_image.url }}"
                        alt="{{ gallery_item.get_title|default:product.get_name }}" class="equipment-card__image">
                    {% else %}
                    <div class="equipment-card__image equipment-card__placeholder">
                        <span class="placeholder-icon">üßä</span>
                        <span class="placeholder-text">3D –º–æ–¥–µ–ª—å</span>
                    </div>
                    {% endif %}

                    <div class="equipment-card__3d-badge">
                        <span class="badge-icon">üßä</span>
                        <span class="badge-text">3D</span>
                    </div>

                    <div class="equipment-card__overlay">
                        <button class="btn btn--3d btn--overlay" data-product-id="{{ product.id }}"
                            data-3d-file="{% if gallery_item.file_3d %}{{ gallery_item.file_3d.url }}{% endif %}"
                            data-title="{{ gallery_item.get_title|default:product.get_name }}">
                            <span class="btn-icon">üëÅÔ∏è</span> –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤ 3D
                        </button>
                        {% if gallery_item.is_downloadable and gallery_item.file_3d %}
                        <a href="{{ gallery_item.file_3d.url }}" download class="btn btn--download btn--overlay">
                            <span class="btn-icon">üì•</span> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                        </a>
                        {% endif %}
                    </div>
                </div>

                {% elif gallery_item.content_type == 'TECHNICAL_DRAWING' %}
                <!-- Technical Drawing -->
                <div class="equipment-card__image-container">
                    {% if gallery_item.preview_image %}
                    <img src="{{ gallery_item.preview_image.url }}"
                        alt="{{ gallery_item.get_title|default:product.get_name }}" class="equipment-card__image">
                    {% else %}
                    <div class="equipment-card__image equipment-card__placeholder">
                        <span class="placeholder-icon">üìê</span>
                        <span class="placeholder-text">–¢–µ—Ö–Ω—ñ—á–Ω–µ –∫—Ä–µ—Å–ª–µ–Ω–Ω—è</span>
                    </div>
                    {% endif %}

                    <div class="equipment-card__overlay">
                        {% if gallery_item.file_3d %}
                        <a href="{{ gallery_item.file_3d.url }}" target="_blank" class="btn btn--view btn--overlay">
                            <span class="btn-icon">üìÑ</span> –í—ñ–¥–∫—Ä–∏—Ç–∏
                        </a>
                        {% if gallery_item.is_downloadable %}
                        <a href="{{ gallery_item.file_3d.url }}" download class="btn btn--download btn--overlay">
                            <span class="btn-icon">üì•</span> –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div class="equipment-card__content">
                    <h4 class="equipment-card__title">
                        {{ gallery_item.get_title|default:gallery_item.get_content_type_display }}
                    </h4>

                    {% if gallery_item.description %}
                    <p class="equipment-card__description">
                        {{ gallery_item.description|truncatewords:15 }}
                    </p>
                    {% endif %}

                    <div class="equipment-card__meta">
                        <span class="meta-type">{{ gallery_item.get_content_type_display }}</span>
                        {% if gallery_item.file_size %}
                        <span class="meta-size">{{ gallery_item.file_size }}</span>
                        {% endif %}
                        {% if gallery_item.download_count > 0 %}
                        <span class="meta-downloads">{{ gallery_item.download_count }} –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Documents Section -->
{% if product.documents.all %}
<section class="catalog-section">
    <div class="container">
        <div class="catalog-header js-observe">
            <p class="catalog-subtitle">–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è</p>
            <h2 class="catalog-title">
                –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ —Ç–∞
                <span class="catalog-title-accent">–¥–æ–∫—É–º–µ–Ω—Ç–∏</span>
            </h2>
            <div class="catalog-underline"></div>
        </div>

        <div class="equipment-grid">
            {% for document in product.documents.all %}
            <div class="equipment-card js-observe">
                <div class="equipment-card__image">
                    üìÑ
                </div>
                <div class="equipment-card__content">
                    <div class="equipment-card__title">
                        {{ document.get_title }}
                    </div>
                    <div class="equipment-card__meta">
                        <a href="{{ document.file.url }}" target="_blank" class="btn btn--outline btn--small">
                            {% trans "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏" %}
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Related Products -->
{% if related_products %}
<section class="catalog-section">
    <div class="container">
        <div class="catalog-header js-observe">
            <p class="catalog-subtitle">–°—Ö–æ–∂—ñ –ø—Ä–æ–¥—É–∫—Ç–∏</p>
            <h2 class="catalog-title">
                –í–∞—Å —Ç–∞–∫–æ–∂ –º–æ–∂–µ
                <span class="catalog-title-accent">–∑–∞—Ü—ñ–∫–∞–≤–∏—Ç–∏</span>
            </h2>
            <div class="catalog-underline"></div>
        </div>

        <div class="equipment-grid">
            {% for related_product in related_products %}
            <div class="equipment-card js-observe">
                <div class="equipment-card__image-container">
                    {% with related_product.gallery.all|first as first_gallery_item %}
                    {% if first_gallery_item.content_type == 'IMAGE' and first_gallery_item.image %}
                    <img src="{{ first_gallery_item.image.url }}" alt="{{ related_product.get_name }}"
                        class="equipment-card__image">
                    {% elif first_gallery_item.content_type == '3D_MODEL' and first_gallery_item.preview_image %}
                    <img src="{{ first_gallery_item.preview_image.url }}" alt="{{ related_product.get_name }}"
                        class="equipment-card__image">
                    {% elif related_product.hero_image %}
                    <img src="{{ related_product.hero_image.url }}" alt="{{ related_product.get_name }}"
                        class="equipment-card__image">
                    {% else %}
                    <div class="equipment-card__image">‚öôÔ∏è</div>
                    {% endif %}
                    {% endwith %}

                    {% if related_product.gallery.all|has_3d_model %}
                    <div class="equipment-card__3d-badge">
                        <span class="badge-icon">üßä</span>
                        <span class="badge-text">3D</span>
                    </div>
                    {% endif %}
                </div>

                <div class="equipment-card__content">
                    <a href="{{ related_product.get_absolute_url }}" class="equipment-card__title">
                        {{ related_product.get_name }}
                    </a>

                    {% if related_product.get_short_description %}
                    <p class="equipment-card__description">
                        {{ related_product.get_short_description|truncatewords:10 }}
                    </p>
                    {% endif %}

                    <div class="equipment-card__meta">
                        {% if related_product.price_usd %}
                        <span class="equipment-card__price">
                            ${{ related_product.price_usd }}
                        </span>
                        {% endif %}

                        <div class="equipment-card__actions">
                            {% with related_product.gallery.all|first_3d_model as first_3d %}
                            {% if first_3d %}
                            <button class="btn btn--3d btn--small" data-product-id="{{ related_product.id }}"
                                data-3d-file="{% if first_3d.file_3d %}{{ first_3d.file_3d.url }}{% endif %}"
                                data-title="{{ related_product.get_name }}">
                                <span class="btn-icon">üëÅÔ∏è</span> 3D
                            </button>
                            {% endif %}
                            {% endwith %}

                            <a href="{{ related_product.get_absolute_url }}" class="btn btn--outline btn--small">
                                {% trans "–î–µ—Ç–∞–ª—å–Ω—ñ—à–µ" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- CTA Section -->
<section class="cta-section">
    <div class="cta-container">
        <div class="cta-content js-observe">
            <p class="cta-question">–ó–∞—Ü—ñ–∫–∞–≤–∏–ª–∏—Å—å –ø—Ä–æ–¥—É–∫—Ç–æ–º?</p>
            <h2 class="cta-title">
                –ó–∞–º–æ–≤—Ç–µ {{ product.get_name }}
                <span class="cta-title-accent">–ø—Ä—è–º–æ –∑–∞—Ä–∞–∑!</span>
            </h2>
            <p class="cta-description">
                –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É —ñ –Ω–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤'—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –≤–∞—Ä—Ç–æ—Å—Ç—ñ
            </p>
            <a href="{% url 'leads:submit' %}" class="btn btn--primary btn--large">
                –ó–∞–º–æ–≤–∏—Ç–∏ –ø—Ä–æ–¥—É–∫—Ç
            </a>
        </div>
        <div class="js-observe">
            <div class="adiabatic-placeholder">
                üõí –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è
            </div>
        </div>
    </div>
</section>
{% endblock %}