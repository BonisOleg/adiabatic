# Універсальна інструкція: Фонове відео з ротацією

## Загальний опис

Ця інструкція описує реалізацію фонового відео на сторінці з автоматичною ротацією між кількома відео на десктопі та оптимізаціями для мобільних пристроїв (особливо iPhone/iOS Safari).

## Архітектура рішення

### Компоненти системи

1. **HTML структура** - контейнер з кількома відео елементами
2. **CSS стилі** - позиціонування, переходи, мобільні та iOS оптимізації
3. **JavaScript логіка** - ротація відео, детекція пристроїв, обробка помилок

---

## 1. HTML структура

### Базовий шаблон

```html
<!-- Контейнер для відео -->
<div class="video-container">
    <!-- Перше відео (активне) -->
    <video class="video-element video-rotating" 
           autoplay 
           muted 
           loop 
           playsinline 
           data-video-index="0">
        <source src="/path/to/video1.mp4" type="video/mp4">
        <source src="/path/to/video2.mp4" type="video/mp4">
        Ваш браузер не підтримує відео.
    </video>
    
    <!-- Друге відео (приховане, буде показане після першого) -->
    <video class="video-element video-rotating video-hidden" 
           autoplay 
           muted 
           loop 
           playsinline 
           data-video-index="1">
        <source src="/path/to/video2.mp4" type="video/mp4">
        <source src="/path/to/video1.mp4" type="video/mp4">
        Ваш браузер не підтримує відео.
    </video>
</div>
```

### Критичні атрибути HTML

| Атрибут | Призначення | Обов'язковість |
|---------|-------------|----------------|
| `autoplay` | Автоматичний запуск відео | ✅ Обов'язково |
| `muted` | Без звуку (потрібно для autoplay) | ✅ Обов'язково |
| `loop` | Зациклення відео | ✅ Обов'язково |
| `playsinline` | **КРИТИЧНО для iOS** - дозволяє inline відтворення | ✅ Обов'язково |
| `data-video-index` | Індекс для ідентифікації відео в JS | ✅ Обов'язково |
| `class="video-hidden"` | Початковий стан другого відео | ✅ Обов'язково |

### Класи для CSS/JS

- `.video-container` - контейнер для всіх відео
- `.video-element` - базовий клас для кожного відео
- `.video-rotating` - клас для відео, що беруть участь у ротації
- `.video-hidden` - клас для прихованого відео (opacity: 0)

---

## 2. CSS стилі

### Базові стилі для десктопу

```css
/* Контейнер відео - фіксована позиція на десктопі */
.video-container {
    position: fixed;  /* На мобільних буде absolute */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;  /* Позаду контенту */
    overflow: hidden;
}

/* Стилі для кожного відео */
.video-element {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;  /* Заповнює весь екран */
    z-index: -1;
    will-change: transform;  /* Оптимізація для анімацій */
}

/* Плавний перехід між відео */
.video-rotating {
    transition: opacity 1s ease-in-out;
    opacity: 1;
}

/* Приховане відео */
.video-hidden {
    opacity: 0;
}
```

### Мобільні оптимізації

```css
/* Для мобільних пристроїв (≤768px) */
@media (max-width: 768px) {
    .video-container,
    .video-element {
        position: absolute;  /* Зміна з fixed на absolute */
    }
    
    .video-rotating {
        opacity: 0.7;  /* Зменшена прозорість */
        will-change: auto;  /* Вимкнення оптимізації */
    }
}
```

### iOS Safari специфічні фікси

```css
/* Детекція iOS Safari */
@supports (-webkit-touch-callout: none) {
    .video-container,
    .video-element {
        position: absolute;  /* Обхід багів fixed на iOS */
    }
    
    .video-rotating {
        /* Апаратне прискорення для плавності */
        -webkit-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
        
        /* Оптимізація для анімацій */
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
        
        -webkit-perspective: 1000;
        perspective: 1000;
    }
}
```

### Fallback для браузерів без підтримки відео

```css
/* Якщо користувач вимкнув анімації */
@media (prefers-reduced-motion: reduce) {
    .video-element {
        display: none;
    }
    
    /* Показати fallback фон */
    .video-container::before {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #color1 0%, #color2 100%);
    }
}
```

---

## 3. JavaScript логіка

### Основна функція ініціалізації

```javascript
function initVideoRotation() {
    // Знайти всі відео з класом ротації
    const videoElements = document.querySelectorAll('.video-rotating');
    
    // Перевірка: потрібно мінімум 2 відео
    if (videoElements.length < 2) {
        console.log('Video rotation requires at least 2 videos');
        return;
    }
    
    let currentIndex = 0;
    
    // Початковий стан: перше відео активно, інші приховані
    videoElements.forEach((video, index) => {
        if (index === 0) {
            video.classList.remove('video-hidden');
            video.play();
            setupVideoEndTransition(video, index);
        } else {
            video.classList.add('video-hidden');
            video.pause();
        }
    });
    
    // Функція відстеження часу відео
    function setupVideoEndTransition(video, videoIndex) {
        function checkVideoTime() {
            const currentTime = video.currentTime;
            const duration = video.duration;
            
            // За 1 секунду до кінця - запускаємо перехід
            if (duration && currentTime >= duration - 1) {
                startTransition(videoIndex);
                return;
            }
            
            // Перевіряємо кожні 100мс
            if (!video.paused) {
                setTimeout(checkVideoTime, 100);
            }
        }
        
        checkVideoTime();
        
        // Додатковий обробник на випадок завершення відео
        video.addEventListener('ended', () => {
            startTransition(videoIndex);
        });
    }
    
    // Функція переходу між відео
    function startTransition(fromIndex) {
        const currentVideo = videoElements[fromIndex];
        const nextIndex = (fromIndex + 1) % videoElements.length;
        const nextVideo = videoElements[nextIndex];
        
        // Підготовка наступного відео
        nextVideo.currentTime = 0;
        nextVideo.classList.remove('video-hidden');
        nextVideo.play();
        
        // Плавний перехід (1 секунда fade)
        setTimeout(() => {
            currentVideo.classList.add('video-hidden');
            
            // Пауза попереднього відео через 1 секунду
            setTimeout(() => {
                currentVideo.pause();
                currentVideo.currentTime = 0;  // Скидання на початок
            }, 1000);
            
            currentIndex = nextIndex;
            
            // Налаштування відстеження для нового активного відео
            setupVideoEndTransition(nextVideo, nextIndex);
        }, 100);
    }
    
    // Обробка помилок завантаження відео
    videoElements.forEach((video, index) => {
        video.addEventListener('error', function (e) {
            console.error(`Video ${index + 1} error:`, e);
            
            // При помилці переключаємося на наступне відео
            if (index === currentIndex) {
                setTimeout(() => startTransition(index), 1000);
            }
        });
        
        // Додаткові обробники для відстеження стану
        video.addEventListener('canplay', function () {
            console.log(`Video ${index + 1} ready to play`);
        });
        
        video.addEventListener('loadedmetadata', function () {
            console.log(`Video ${index + 1} metadata loaded, duration: ${video.duration}s`);
        });
    });
    
    // Мобільна оптимізація
    const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
    if (isMobile) {
        // На мобільних: пауза всіх відео, показ лише першого
        videoElements.forEach(video => {
            video.muted = true;
            video.pause();
            video.style.opacity = '0.7';
        });
        
        // Показуємо лише перше відео як статичне зображення
        videoElements[0].classList.remove('video-hidden');
        console.log('Mobile detected - video rotation disabled');
    }
    
    // iOS Safari оптимізації
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) {
        videoElements.forEach(video => {
            video.playsInline = true;
            video.muted = true;
            video.setAttribute('webkit-playsinline', 'true');
        });
        console.log('iOS Safari optimizations applied');
    }
}
```

### Ініціалізація при завантаженні сторінки

```javascript
document.addEventListener('DOMContentLoaded', function () {
    initVideoRotation();
});
```

---

## 4. Мета-теги для iOS (в `<head>`)

```html
<!-- iOS Safari оптимізації -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
```

---

## 5. Критичні моменти для iPhone/iOS

### 1. Атрибут `playsinline`
**ОБОВ'ЯЗКОВО** додати до кожного `<video>`:
```html
<video playsinline ...>
```

### 2. JavaScript встановлення для iOS
```javascript
video.playsInline = true;
video.setAttribute('webkit-playsinline', 'true');
```

### 3. CSS позиціонування
На iOS використовуйте `position: absolute` замість `fixed`:
```css
@supports (-webkit-touch-callout: none) {
    .video-container,
    .video-element {
        position: absolute;
    }
}
```

### 4. Апаратне прискорення
```css
.video-rotating {
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
}
```

### 5. Viewport висота
```css
@supports (-webkit-touch-callout: none) {
    .hero-section {
        min-height: -webkit-fill-available;
    }
}
```

---

## 6. Логіка роботи системи

### Послідовність дій

1. **Завантаження сторінки**
   - DOMContentLoaded → виклик `initVideoRotation()`

2. **Ініціалізація**
   - Знаходження всіх `.video-rotating` елементів
   - Перевірка: мінімум 2 відео
   - Детекція пристрою (мобільний/iOS)

3. **Початковий стан**
   - Перше відео: `class="video-rotating"` (без `video-hidden`)
   - Інші відео: `class="video-rotating video-hidden"`
   - Запуск першого відео: `video.play()`

4. **Відстеження часу**
   - Перевірка кожні 100мс: `currentTime >= duration - 1`
   - За 1 секунду до кінця → виклик `startTransition()`

5. **Перехід між відео**
   - Наступне відео: `currentTime = 0`, `remove('video-hidden')`, `play()`
   - Через 100мс: поточне відео → `add('video-hidden')`
   - Через 1 секунду: пауза попереднього, скидання на початок
   - Налаштування відстеження для нового активного відео

6. **Мобільні пристрої**
   - Детекція: `window.innerWidth <= 768 || 'ontouchstart' in window`
   - Дія: пауза всіх відео, opacity 0.7, показ лише першого
   - Ротація відключена

7. **iOS Safari**
   - Детекція: `/iPad|iPhone|iPod/.test(navigator.userAgent)`
   - Дія: `playsInline = true`, `webkit-playsinline = true`

---

## 7. Обробка помилок

### Помилки завантаження відео
```javascript
video.addEventListener('error', function (e) {
    // Автоматичне переключення на наступне відео
    if (index === currentIndex) {
        setTimeout(() => startTransition(index), 1000);
    }
});
```

### Fallback для браузерів без підтримки
- CSS: `@media (prefers-reduced-motion: reduce)` → приховати відео
- HTML: текст "Ваш браузер не підтримує відео" всередині `<video>`

---

## 8. Оптимізації продуктивності

### Для десктопу
- `will-change: transform` - підготовка до анімацій
- `transition: opacity 1s` - плавний перехід
- Перевірка часу кожні 100мс (не постійно)

### Для мобільних
- Відключення ротації (економія батареї)
- `will-change: auto` - вимкнення оптимізацій
- `opacity: 0.7` - зменшена прозорість

### Для iOS
- `translate3d(0, 0, 0)` - апаратне прискорення
- `backface-visibility: hidden` - оптимізація анімацій
- `position: absolute` - обхід багів fixed

---

## 9. Чеклист імплементації

### HTML
- [ ] Контейнер `.video-container`
- [ ] Мінімум 2 відео з класом `.video-rotating`
- [ ] Атрибути: `autoplay`, `muted`, `loop`, `playsinline`
- [ ] `data-video-index` для кожного відео
- [ ] Перше відео без `.video-hidden`, інші з `.video-hidden`

### CSS
- [ ] Базові стилі для `.video-container` та `.video-element`
- [ ] `position: fixed` для десктопу, `absolute` для мобільних
- [ ] Переходи: `.video-rotating` та `.video-hidden`
- [ ] Медіа-запит для мобільних (≤768px)
- [ ] `@supports (-webkit-touch-callout: none)` для iOS
- [ ] Fallback для `prefers-reduced-motion`

### JavaScript
- [ ] Функція `initVideoRotation()`
- [ ] Відстеження часу відео (перевірка кожні 100мс)
- [ ] Функція `startTransition()` для переключення
- [ ] Детекція мобільних пристроїв
- [ ] Детекція iOS та встановлення `playsInline`
- [ ] Обробка помилок завантаження
- [ ] Ініціалізація на `DOMContentLoaded`

### Мета-теги
- [ ] `apple-mobile-web-app-capable`
- [ ] `viewport-fit=cover`
- [ ] `format-detection=telephone=no`

---

## 10. Тестування

### Десктоп
- [ ] Відео автоматично запускається
- [ ] Ротація працює між відео
- [ ] Плавний перехід (1 секунда fade)
- [ ] Відео зациклені безперервно

### Мобільні (Android/iOS)
- [ ] Відео не ротуються (показується лише перше)
- [ ] Відео паузується або має зменшену opacity
- [ ] Немає проблем з продуктивністю

### iOS Safari (iPhone/iPad)
- [ ] Відео відтворюється inline (не в fullscreen)
- [ ] Автоплей працює
- [ ] Немає багів з позиціонуванням
- [ ] Плавні анімації (апаратне прискорення)

### Помилки
- [ ] При помилці завантаження відео переключається на наступне
- [ ] Fallback працює для браузерів без підтримки

---

## 11. Типові проблеми та рішення

### Проблема: Відео не відтворюється на iPhone
**Рішення:**
- Перевірити наявність `playsinline` в HTML
- Додати `video.playsInline = true` в JavaScript
- Додати `webkit-playsinline="true"` атрибут

### Проблема: Відео відкривається в fullscreen на iOS
**Рішення:**
- Обов'язково додати `playsinline` атрибут
- Встановити `video.playsInline = true` в JS

### Проблема: Відео не позиціонується правильно на iOS
**Рішення:**
- Використати `position: absolute` замість `fixed` в `@supports (-webkit-touch-callout: none)`

### Проблема: Ротація не працює
**Рішення:**
- Перевірити, що є мінімум 2 відео
- Перевірити наявність класів `.video-rotating`
- Перевірити, що перше відео без `.video-hidden`

### Проблема: Різкий перехід між відео
**Рішення:**
- Перевірити CSS: `transition: opacity 1s ease-in-out`
- Перевірити, що перехід запускається за 1 секунду до кінця

---

## 12. Абстрактна структура файлів

```
project/
├── templates/
│   └── page.html          # HTML з відео контейнером
├── static/
│   ├── css/
│   │   └── video.css      # Стилі для відео
│   ├── js/
│   │   └── video.js       # JavaScript логіка
│   └── video/
│       ├── video1.mp4     # Перше відео
│       └── video2.mp4     # Друге відео
└── base.html              # Базовий шаблон з мета-тегами
```

---

## Висновок

Ця інструкція описує повну реалізацію фонового відео з ротацією, яка працює на десктопі та оптимізована для мобільних пристроїв, особливо iPhone/iOS Safari. Всі назви класів, функцій та змінних є абстрактними і можуть бути замінені на будь-які інші назви в вашому проекті, зберігаючи ту саму логіку та структуру.

**Ключові принципи:**
1. Мінімум 2 відео для ротації
2. Обов'язковий атрибут `playsinline` для iOS
3. Детекція пристроїв та відповідні оптимізації
4. Плавні переходи через CSS opacity transition
5. Обробка помилок та fallback механізми


